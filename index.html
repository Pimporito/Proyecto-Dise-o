<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reservas Deportes (simulado)</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:#ffffff;color:#111827}
    header{padding:16px 20px;background:#f1f5f9;border-bottom:1px solid #e2e8f0}
    h1{margin:0;font-size:18px}
    main{padding:20px}
    table{width:100%;border-collapse:collapse;background:#ffffff;border:1px solid #e2e8f0;border-radius:10px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:left}
    th{background:#eef2ff;color:#0f172a}
    tr:last-child td{border-bottom:none}
    .actions{display:flex;gap:8px}
    button{padding:6px 10px;border-radius:8px;border:1px solid #cbd5e1;background:#f8fafc;color:#0f172a;cursor:pointer}
    button:hover{background:#eef2f7}
    button.primary{background:#2563eb;color:#fff;border-color:#1d4ed8}
    button.primary:hover{background:#1d4ed8}
    button.danger{background:#ef4444;color:#fff;border-color:#dc2626}
    button.danger:hover{background:#dc2626}
    button:disabled{opacity:.55;cursor:not-allowed}
    .msg{margin-top:10px;min-height:1.2em;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono";font-size:12px;color:#334155}
  </style>
</head>
<body>
  <header><h1>Reservas de Deportes</h1></header>
  <main>
    <div class="msg">Simulación local (sin ESP8266). Se guarda en tu navegador.</div>
    <table id="tabla">
      <thead>
        <tr>
          <th>Deporte</th>
          <th>Profesor</th>
          <th>Hora inicio</th>
          <th>Hora término</th>
          <th>Reservados</th>
          <th>Cupo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </main>

  <script>
    const base = [
      {deporte:"Aerobox", profesor:"Guillermo Octavio Chamorro Urbina", horaInicio:"06-10-2025 15:00", horaFin:"06-10-2025 16:10", reservados:15, cupo:20},
      {deporte:"Básquetbol", profesor:"Aldo Devoto Olguin", horaInicio:"06-10-2025 15:00", horaFin:"06-10-2025 16:10", reservados:9, cupo:20},
      {deporte:"Cross Training", profesor:"Ignacio Ordinas", horaInicio:"06-10-2025 15:00", horaFin:"06-10-2025 16:10", reservados:7, cupo:25},
      {deporte:"Escalada", profesor:"Martin Morales", horaInicio:"06-10-2025 15:00", horaFin:"06-10-2025 16:10", reservados:10, cupo:10},
      {deporte:"Fit Ball", profesor:"Maria Paz Ulzurrun", horaInicio:"06-10-2025 15:00", horaFin:"06-10-2025 16:10", reservados:20, cupo:20},
      {deporte:"Futbolito Hombres", profesor:"Maximiliano Hernández", horaInicio:"06-10-2025 15:00", horaFin:"06-10-2025 16:10", reservados:31, cupo:40},
      {deporte:"Gimnasio", profesor:"Sebastián Fuenzalida", horaInicio:"06-10-2025 15:00", horaFin:"06-10-2025 16:10", reservados:100, cupo:100},
      {deporte:"Fit Ball", profesor:"Maria Paz Ulzurrun", horaInicio:"06-10-2025 16:30", horaFin:"06-10-2025 17:40", reservados:5, cupo:20},
      {deporte:"Futbolito Hombres (24).", profesor:"Maximiliano Hernández", horaInicio:"06-10-2025 16:30", horaFin:"06-10-2025 17:40", reservados:3, cupo:24},
      {deporte:"Gimnasio", profesor:"Sebastián Fuenzalida", horaInicio:"06-10-2025 16:30", horaFin:"06-10-2025 17:40", reservados:77, cupo:100},
      {deporte:"Gimnasio", profesor:"Sebastián Fuenzalida", horaInicio:"06-10-2025 18:00", horaFin:"06-10-2025 19:10", reservados:100, cupo:100}
    ];

    const DATA_KEY = "reservas_demo_v3_data";
    const USER_KEY = "reservas_demo_v3_user";

    function loadData(){
      try{
        const s = localStorage.getItem(DATA_KEY);
        if(!s) return structuredClone(base);
        const arr = JSON.parse(s);
        if(!Array.isArray(arr) || arr.length !== base.length) return structuredClone(base);
        return arr;
      }catch{ return structuredClone(base); }
    }
    function saveData(arr){ localStorage.setItem(DATA_KEY, JSON.stringify(arr)); }

    function loadUser(){
      try{
        const s = localStorage.getItem(USER_KEY);
        if(!s) return { reservedIndex:null };
        const u = JSON.parse(s);
        if(typeof u?.reservedIndex !== "number" && u?.reservedIndex !== null) return { reservedIndex:null };
        return u;
      }catch{ return { reservedIndex:null }; }
    }
    function saveUser(u){ localStorage.setItem(USER_KEY, JSON.stringify(u)); }

    let actividades = loadData();
    let user = loadUser();

    const tbody = document.getElementById("tbody");

    function render(){
      tbody.innerHTML = "";
      actividades.forEach((a,i)=>{
        const lleno = a.reservados >= a.cupo;
        const yoAqui = user.reservedIndex === i;
        const tengoReservaEnOtro = user.reservedIndex !== null && !yoAqui;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.deporte}</td>
          <td>${a.profesor}</td>
          <td>${a.horaInicio}</td>
          <td>${a.horaFin}</td>
          <td id="res-${i}">${a.reservados}</td>
          <td id="cupo-${i}">${a.cupo}</td>
          <td class="actions" id="act-${i}"></td>
        `;
        tbody.appendChild(tr);

        const cell = document.getElementById(\`act-\${i}\`);

        if(yoAqui){
          const bCancel = document.createElement("button");
          bCancel.className = "danger";
          bCancel.textContent = "Cancelar";
          bCancel.addEventListener("click", ()=>cancelar(i));
          cell.appendChild(bCancel);
        } else {
          const bRes = document.createElement("button");
          bRes.className = "primary";
          bRes.textContent = lleno ? "Sin cupos" : "Reservar";
          bRes.disabled = lleno || tengoReservaEnOtro;
          if(tengoReservaEnOtro) bRes.title = "Ya tienes una reserva. Cancélala para reservar otra.";
          bRes.addEventListener("click", ()=>reservar(i));
          cell.appendChild(bRes);
        }
      });
    }

    function reservar(i){
      if(user.reservedIndex !== null) return;
      const a = actividades[i];
      if(a.cupo <= 0) return;
      a.reservados += 1;
      a.cupo -= 1;
      user.reservedIndex = i;
      saveData(actividades); saveUser(user);
      actualizarFila(i); render();
    }

    function cancelar(i){
      if(user.reservedIndex !== i) return;
      const a = actividades[i];
      if(a.reservados > 0) a.reservados -= 1;
      a.cupo += 1;
      user.reservedIndex = null;
      saveData(actividades); saveUser(user);
      actualizarFila(i); render();
    }

    function actualizarFila(i){
      document.getElementById(\`res-\${i}\`).textContent = actividades[i].reservados;
      document.getElementById(\`cupo-\${i}\`).textContent = actividades[i].cupo;
    }

    render();
  </script>
</body>
</html>
